<!DOCTYPE html>
<html>
<head>
    <title>🔍 Detailed API Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #dee2e6; }
        .debug-log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; overflow-x: auto; margin: 10px 0; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        button { background: #007cba; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a8b; }
        .test-result { background: #f0f8ff; border: 2px solid #007cba; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Detailed API Debug Test</h1>
        <p>This test includes extensive debugging to identify the exact failure point in the API configuration endpoint.</p>
        
        <div class="test-section">
            <h2>🎯 API Configuration Test with Enhanced Debugging</h2>
            <button onclick="testDetailedConfig()">Test Configuration Endpoint</button>
            <div id="debug-output" class="debug-log">Debug output will appear here...</div>
        </div>
        
        <div class="test-section">
            <h2>📋 Error Log Instructions</h2>
            <p><strong>After running the test, check your aMember error logs for:</strong></p>
            <ul>
                <li><code>Passkey Plugin: onApiRoute ENTRY</code> - Confirms API routing started</li>
                <li><code>Passkey Plugin: Got request object</code> - Confirms request object exists</li>
                <li><code>Passkey Plugin: API permission check PASSED</code> - Confirms authentication works</li>
                <li><code>Passkey Plugin: Matched passkey config endpoint</code> - Confirms endpoint matching</li>
                <li><code>Passkey Plugin: handlePasskeyConfig called</code> - Confirms method entry</li>
                <li><code>Passkey Plugin: CRITICAL ERROR</code> - Any fatal errors with stack trace</li>
            </ul>
            
            <h3>🗂️ Common aMember Error Log Locations:</h3>
            <ul>
                <li><code>/var/www/html/[site]/application/data/log/error.log</code></li>
                <li><code>/path/to/amember/data/log/error.log</code></li>
                <li><code>/var/log/apache2/error.log</code> (system-wide)</li>
                <li>aMember Admin → Setup → Error Log</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h2>🔧 Debugging Commands</h2>
            <p>Use these commands to monitor logs in real-time:</p>
            <div class="debug-log">
# Watch aMember error logs
tail -f /var/www/html/*/application/data/log/error.log

# Watch system error logs  
tail -f /var/log/apache2/error.log

# Filter for passkey plugin messages only
tail -f /var/log/apache2/error.log | grep "Passkey Plugin"
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toISOString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            output.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testDetailedConfig() {
            const output = document.getElementById('debug-output');
            output.innerHTML = ''; // Clear previous output
            
            log('🔍 Starting detailed configuration endpoint test...', 'info');
            log('This test includes extensive debug logging to identify the failure point.', 'info');
            
            try {
                // Test the configuration endpoint with detailed logging
                log('📡 Calling /api/passkey/config endpoint...', 'info');
                
                const response = await fetch('/api/passkey/config', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                log(`📊 Response Status: ${response.status} ${response.statusText}`, 'info');
                log(`📋 Response Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`, 'info');
                
                const responseText = await response.text();
                log(`📄 Raw Response Text (first 500 chars): ${responseText.substring(0, 500)}`, 'info');
                
                let responseData;
                try {
                    responseData = JSON.parse(responseText);
                    log(`✅ Valid JSON response received`, 'success');
                    log(`📦 Response Data: ${JSON.stringify(responseData, null, 2)}`, 'info');
                } catch (parseError) {
                    log(`❌ Invalid JSON response: ${parseError.message}`, 'error');
                    log(`🔍 Full response text: ${responseText}`, 'error');
                    return;
                }
                
                // Analyze the response
                if (responseData.ok === true) {
                    log('🎉 SUCCESS: Configuration endpoint returned valid data!', 'success');
                    log(`🏆 Configuration: ${JSON.stringify(responseData, null, 2)}`, 'success');
                } else if (responseData.error) {
                    log(`❌ API ERROR: ${responseData.error}`, 'error');
                    if (responseData.debug) {
                        log(`🐛 Debug Info: ${responseData.debug}`, 'warning');
                    }
                } else {
                    log('⚠️ Unexpected response format', 'warning');
                    log(`📊 Response: ${JSON.stringify(responseData, null, 2)}`, 'warning');
                }
                
            } catch (error) {
                log(`💥 NETWORK ERROR: ${error.message}`, 'error');
                log(`📚 Error Details: ${error.stack}`, 'error');
            }
            
            log('', 'info');
            log('🔍 NEXT STEPS:', 'info');
            log('1. Check your aMember error logs for "Passkey Plugin:" messages', 'info');
            log('2. Look for the exact point where logging stops', 'info');
            log('3. Look for any PHP fatal errors or exceptions', 'info');
            log('4. Share the complete debug output from the error logs', 'info');
        }

        // Auto-run test when page loads
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Detailed debug test page loaded. Click "Test Configuration Endpoint" to start.', 'info');
        });
    </script>
</body>
</html>
