<!DOCTYPE html>
<html>
<head>
    <title>üîß Local Plugin Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-box { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border: 1px solid #dee2e6; }
        .success { border-left: 4px solid #28a745; background: #d4edda; }
        .error { border-left: 4px solid #dc3545; background: #f8d7da; }
        .warning { border-left: 4px solid #ffc107; background: #fff3cd; }
        .info { border-left: 4px solid #17a2b8; background: #d1ecf1; }
        button { background: #007cba; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px; }
        .debug-log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Local Plugin Debug Test</h1>
        <p>Testing API endpoints and troubleshooting the 404 errors.</p>
        
        <div class="status-box info">
            <h3>üéØ Current Issue</h3>
            <p>Getting 404 errors when testing API endpoints. This suggests:</p>
            <ul>
                <li>API routing might not be set up correctly</li>
                <li>Plugin might not be loaded in aMember</li>
                <li>API endpoint paths might be incorrect</li>
            </ul>
        </div>
        
        <button onclick="testMultipleEndpoints()">Test Multiple API Endpoints</button>
        <button onclick="testPluginPaths()">Test Plugin-Specific Paths</button>
        <button onclick="testServerInfo()">Get Server Info</button>
        
        <div id="test-output" class="debug-log">Test output will appear here...</div>
        
        <div class="status-box warning">
            <h3>‚ö†Ô∏è Troubleshooting Steps</h3>
            <ol>
                <li><strong>Check if aMember is running:</strong> Try accessing your aMember admin panel</li>
                <li><strong>Verify plugin location:</strong> Ensure plugin is in correct aMember directory</li>
                <li><strong>Check aMember logs:</strong> Look for plugin loading errors</li>
                <li><strong>Test basic aMember API:</strong> Try other aMember API endpoints</li>
            </ol>
        </div>
        
        <div class="status-box info">
            <h3>üìã Expected Plugin Location</h3>
            <p>Based on your error logs, the plugin should be at:</p>
            <pre>/var/www/html/kumpeapps.com/www/application/default/plugins/misc/passkey/passkey.php</pre>
            <p>Local development path:</p>
            <pre>/Users/justinkumpe/Documents/amember_plugin_passkey/passkey.php</pre>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('test-output');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const colorClass = type === 'error' ? 'color: #ff6b6b' : type === 'success' ? 'color: #51cf66' : type === 'warning' ? 'color: #ffd43b' : 'color: #74c0fc';
            output.innerHTML += `<span style="${colorClass}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        async function testMultipleEndpoints() {
            document.getElementById('test-output').innerHTML = '';
            log('üîç Testing multiple API endpoints...', 'info');
            
            // aMember installation is at www.kumpeapps.com
            const amemberDomain = 'https://www.kumpeapps.com';
            
            const endpoints = [
                `${amemberDomain}/api/passkey/config`,
                `${amemberDomain}/api/passkey-config`, 
                `${amemberDomain}/misc/passkey?action=config`,
                `${amemberDomain}/misc/passkey`,
                `${amemberDomain}/api/`,
                `${amemberDomain}/admin/`,
                // Test local relative paths (these will 404 as expected)
                '/api/passkey/config',
                '/misc/passkey?action=config'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    log(`üì° Testing: ${endpoint}`, 'info');
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                    
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    log(`  Status: ${response.status} ${response.statusText}`, 
                        response.status === 200 ? 'success' : response.status === 404 ? 'error' : 'warning');
                    
                    if (response.status !== 404) {
                        const responseText = await response.text();
                        if (responseText.length < 200) {
                            log(`  Response: ${responseText}`, 'info');
                        } else {
                            log(`  Response Length: ${responseText.length} chars`, 'info');
                            log(`  Preview: ${responseText.substring(0, 100)}...`, 'info');
                        }
                    }
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        log(`  ‚è∞ Timeout for ${endpoint}`, 'warning');
                    } else {
                        log(`  üí• Error: ${error.message}`, 'error');
                    }
                }
                
                log('', 'info'); // Empty line for readability
            }
            
            log('üéØ Test complete. Look for non-404 responses above.', 'info');
        }

        async function testPluginPaths() {
            document.getElementById('test-output').innerHTML = '';
            log('üîç Testing plugin-specific paths...', 'info');
            
            // aMember installation is at www.kumpeapps.com
            const amemberDomain = 'https://www.kumpeapps.com';
            
            const pluginPaths = [
                `${amemberDomain}/misc/passkey?_plugin=passkey&_action=test`,
                `${amemberDomain}/misc/passkey?action=test`,
                `${amemberDomain}/misc/passkey?action=status`,
                `${amemberDomain}/misc/passkey?action=debug`,
                `${amemberDomain}/plugins/misc/passkey/passkey.php`,
                `${amemberDomain}/application/default/plugins/misc/passkey/passkey.php`
            ];
            
            for (const path of pluginPaths) {
                try {
                    log(`üîå Testing plugin path: ${path}`, 'info');
                    
                    const response = await fetch(path, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    log(`  Status: ${response.status} ${response.statusText}`, 
                        response.status === 200 ? 'success' : 'warning');
                    
                    if (response.status !== 404) {
                        const text = await response.text();
                        if (text.length < 300) {
                            log(`  Response: ${text}`, 'info');
                        } else {
                            log(`  Response length: ${text.length} chars`, 'info');
                        }
                    }
                    
                } catch (error) {
                    log(`  üí• Error: ${error.message}`, 'error');
                }
            }
        }

        async function testServerInfo() {
            document.getElementById('test-output').innerHTML = '';
            log('üåê Getting server information...', 'info');
            
            // Test current domain and path
            log(`Current URL: ${window.location.href}`, 'info');
            log(`Domain: ${window.location.hostname}`, 'info');
            log(`Protocol: ${window.location.protocol}`, 'info');
            log(`Port: ${window.location.port || 'default'}`, 'info');
            
            // Test if this is a local development environment
            if (window.location.hostname === 'localhost' || 
                window.location.hostname === '127.0.0.1' ||
                window.location.hostname.includes('local')) {
                log('üîß Local development environment detected', 'warning');
                log('API endpoints may need different paths for local testing', 'warning');
            } else {
                log('üåç Production/remote environment detected', 'info');
            }
            
            // Test basic connectivity
            try {
                const response = await fetch('/', { method: 'HEAD' });
                log(`‚úÖ Basic server connectivity: ${response.status}`, 'success');
            } catch (error) {
                log(`‚ùå Server connectivity issue: ${error.message}`, 'error');
            }
        }

        // Auto-run basic info on load
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Local Plugin Debug Test loaded', 'info');
            log('Run tests above to troubleshoot the 404 errors', 'info');
            testServerInfo();
        });
    </script>
</body>
</html>
