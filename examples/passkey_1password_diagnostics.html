<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1Password Diagnostic Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover:not(:disabled) { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .debug { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-family: monospace; 
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .diagnostic-section {
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        .result.pass { background: #d4edda; color: #155724; }
        .result.fail { background: #f8d7da; color: #721c24; }
        .result.unknown { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç 1Password WebAuthn Diagnostic</h1>
        <p>Comprehensive diagnostic to identify why 1Password isn't responding to WebAuthn calls.</p>
        
        <div id="status">Running 1Password diagnostics...</div>
        
        <div class="diagnostic-section">
            <h3>üîß Environment Diagnostics</h3>
            <div id="envResults"></div>
        </div>
        
        <div class="diagnostic-section">
            <h3>üß© 1Password Extension Detection</h3>
            <div id="extensionResults"></div>
        </div>
        
        <div class="diagnostic-section">
            <h3>üåê WebAuthn Platform Tests</h3>
            <div id="webauthnResults"></div>
        </div>
        
        <div class="diagnostic-section">
            <h3>üéØ 1Password-Specific Tests</h3>
            <button onclick="test1PasswordWebAuthn()">üîë Test 1Password WebAuthn</button>
            <button onclick="testDelayedWebAuthn()">‚è±Ô∏è Test with Delay</button>
            <button onclick="testWithCredentialHints()">üí° Test with Credential Hints</button>
            <div id="testResults"></div>
        </div>
        
        <div class="debug" id="debugLog">Debug logs will appear here...</div>
    </div>

    <script>
        const debugLog = document.getElementById('debugLog');
        
        function log(message) {
            console.log(message);
            debugLog.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
            debugLog.scrollTop = debugLog.scrollHeight;
        }
        
        function addResult(containerId, test, result, details = '') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${result}`;
            resultDiv.innerHTML = `<strong>${test}:</strong> ${result.toUpperCase()} ${details}`;
            container.appendChild(resultDiv);
        }

        // Environment diagnostics
        function runEnvironmentDiagnostics() {
            log('üîß Running environment diagnostics...');
            
            // Browser detection
            const userAgent = navigator.userAgent;
            const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
            const isChrome = /Chrome/.test(userAgent);
            const isFirefox = /Firefox/.test(userAgent);
            
            addResult('envResults', 'Browser', isSafari ? 'pass' : 'unknown', 
                `${isSafari ? 'Safari' : isChrome ? 'Chrome' : isFirefox ? 'Firefox' : 'Unknown'}`);
            
            // HTTPS check
            const isHTTPS = location.protocol === 'https:';
            addResult('envResults', 'HTTPS', isHTTPS ? 'pass' : 'fail', location.protocol);
            
            // Domain check
            const domain = window.location.hostname;
            addResult('envResults', 'Domain', 'pass', domain);
            
            // WebAuthn support
            const hasWebAuthn = !!window.PublicKeyCredential;
            addResult('envResults', 'WebAuthn API', hasWebAuthn ? 'pass' : 'fail');
            
            log('‚úÖ Environment diagnostics complete');
        }

        // 1Password extension detection
        async function detect1PasswordExtension() {
            log('üß© Detecting 1Password extension...');
            
            // Method 1: DOM inspection
            const onePasswordElements = document.querySelectorAll('[data-1p-ignore], [data-onepassword-cc-type], .onepassword-extension-element');
            addResult('extensionResults', '1Password DOM markers', onePasswordElements.length > 0 ? 'pass' : 'fail', 
                `Found ${onePasswordElements.length} elements`);
            
            // Method 2: Check for 1Password-specific APIs
            const has1PInterface = !!(window.OnePasswordExtension || window.op);
            addResult('extensionResults', '1Password API interface', has1PInterface ? 'pass' : 'fail');
            
            // Method 3: Injection detection
            setTimeout(() => {
                const injectedElements = document.querySelectorAll('[class*="onepassword"], [id*="onepassword"], [data-testid*="onepassword"]');
                addResult('extensionResults', '1Password injected elements', injectedElements.length > 0 ? 'pass' : 'fail', 
                    `Found ${injectedElements.length} elements after delay`);
            }, 2000);
            
            // Method 4: Check for extension-specific CSS
            const hasExtensionCSS = Array.from(document.styleSheets).some(sheet => {
                try {
                    return sheet.href && (sheet.href.includes('onepassword') || sheet.href.includes('1password'));
                } catch (e) {
                    return false;
                }
            });
            addResult('extensionResults', '1Password CSS injection', hasExtensionCSS ? 'pass' : 'fail');
            
            log('‚úÖ 1Password extension detection complete');
        }

        // WebAuthn platform tests
        async function runWebAuthnTests() {
            log('üåê Running WebAuthn platform tests...');
            
            try {
                // Check platform authenticator availability
                if (window.PublicKeyCredential && window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable) {
                    const platformAvailable = await window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                    addResult('webauthnResults', 'Platform authenticator', platformAvailable ? 'pass' : 'fail');
                } else {
                    addResult('webauthnResults', 'Platform authenticator API', 'fail', 'API not available');
                }
                
                // Check conditional mediation support
                if (window.PublicKeyCredential && window.PublicKeyCredential.isConditionalMediationAvailable) {
                    const conditionalAvailable = await window.PublicKeyCredential.isConditionalMediationAvailable();
                    addResult('webauthnResults', 'Conditional mediation', conditionalAvailable ? 'pass' : 'fail');
                } else {
                    addResult('webauthnResults', 'Conditional mediation API', 'fail', 'API not available');
                }
                
            } catch (error) {
                addResult('webauthnResults', 'WebAuthn API test', 'fail', error.message);
            }
            
            log('‚úÖ WebAuthn platform tests complete');
        }

        // Get aMember-compatible challenge
        async function getAmemberChallenge() {
            const response = await fetch("secure_passkey_auth.php?action=amember-challenge");
            if (!response.ok) throw new Error(`Challenge failed: ${response.status}`);
            const data = await response.json();
            if (data.status !== "ok") throw new Error(data.error || "Challenge generation failed");
            return data.options;
        }

        function base64urlToUint8Array(base64url) {
            const base64 = base64url.replace(/-/g, "+").replace(/_/g, "/").padEnd(base64url.length + (4 - base64url.length % 4) % 4, "=");
            return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
        }

        // Test 1: Standard 1Password WebAuthn call
        async function test1PasswordWebAuthn() {
            log('üîë Testing 1Password WebAuthn call...');
            try {
                const challengeOptions = await getAmemberChallenge();
                const options = {
                    challenge: base64urlToUint8Array(challengeOptions.challenge),
                    timeout: challengeOptions.timeout,
                    rpId: "www.kumpeapps.com",
                    userVerification: challengeOptions.userVerification,
                    allowCredentials: []
                };
                
                log('üì° Calling WebAuthn with standard approach...');
                const credential = await navigator.credentials.get({ publicKey: options });
                
                log('‚úÖ 1Password WebAuthn SUCCESS!');
                addResult('testResults', '1Password WebAuthn', 'pass', 'Successfully authenticated');
                
            } catch (error) {
                log('‚ùå 1Password WebAuthn failed: ' + error.message);
                addResult('testResults', '1Password WebAuthn', 'fail', error.message);
            }
        }

        // Test 2: WebAuthn with delay (1Password needs time)
        async function testDelayedWebAuthn() {
            log('‚è±Ô∏è Testing WebAuthn with delay for 1Password...');
            try {
                // Wait for 1Password to fully initialize
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const challengeOptions = await getAmemberChallenge();
                const options = {
                    challenge: base64urlToUint8Array(challengeOptions.challenge),
                    timeout: challengeOptions.timeout,
                    rpId: "www.kumpeapps.com",
                    userVerification: challengeOptions.userVerification,
                    allowCredentials: []
                };
                
                log('üì° Calling WebAuthn after 3-second delay...');
                const credential = await navigator.credentials.get({ publicKey: options });
                
                log('‚úÖ Delayed WebAuthn SUCCESS!');
                addResult('testResults', 'Delayed WebAuthn', 'pass', 'Authentication successful after delay');
                
            } catch (error) {
                log('‚ùå Delayed WebAuthn failed: ' + error.message);
                addResult('testResults', 'Delayed WebAuthn', 'fail', error.message);
            }
        }

        // Test 3: WebAuthn with credential hints
        async function testWithCredentialHints() {
            log('üí° Testing WebAuthn with credential hints...');
            try {
                // Try to get actual credential IDs from server
                let allowCredentials = [];
                try {
                    const credsResponse = await fetch("secure_passkey_auth.php?action=get-credentials");
                    const credsData = await credsResponse.json();
                    if (credsData.credentials && credsData.credentials.length > 0) {
                        allowCredentials = credsData.credentials.map(cred => ({
                            type: 'public-key',
                            id: base64urlToUint8Array(cred.id),
                            transports: ['internal', 'hybrid']
                        }));
                        log(`üìã Using ${allowCredentials.length} credential hints`);
                    }
                } catch (e) {
                    log('‚ö†Ô∏è Could not get credential hints, using empty array');
                }
                
                const challengeOptions = await getAmemberChallenge();
                const options = {
                    challenge: base64urlToUint8Array(challengeOptions.challenge),
                    timeout: challengeOptions.timeout,
                    rpId: "www.kumpeapps.com",
                    userVerification: challengeOptions.userVerification,
                    allowCredentials: allowCredentials
                };
                
                log('üì° Calling WebAuthn with credential hints...');
                const credential = await navigator.credentials.get({ publicKey: options });
                
                log('‚úÖ WebAuthn with hints SUCCESS!');
                addResult('testResults', 'WebAuthn with hints', 'pass', 'Authentication successful with credential hints');
                
            } catch (error) {
                log('‚ùå WebAuthn with hints failed: ' + error.message);
                addResult('testResults', 'WebAuthn with hints', 'fail', error.message);
            }
        }

        // Run all diagnostics on load
        document.addEventListener('DOMContentLoaded', async function() {
            log('üöÄ Starting 1Password diagnostics...');
            
            runEnvironmentDiagnostics();
            await detect1PasswordExtension();
            await runWebAuthnTests();
            
            document.getElementById('status').innerHTML = '‚úÖ Diagnostics complete. Check results above and try the 1Password-specific tests.';
            document.getElementById('status').className = 'status info';
            
            log('‚úÖ All diagnostics complete');
        });
    </script>
</body>
</html>
