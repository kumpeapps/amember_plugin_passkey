<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Admin Save Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-section h3 { margin-top: 0; color: #333; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a8a; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
        input[type="text"] { width: 100%; padding: 8px; margin: 5px 0; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Direct Admin Save Test</h1>
        <p>This page directly tests the configuration save process that should happen when admin changes settings.</p>
        
        <div class="test-section">
            <h3>1. Current Configuration Detection</h3>
            <button onclick="testConfigDetection()">Test Config Detection</button>
            <div id="config-detection-result"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Direct Config Save Test</h3>
            <p>This simulates what happens when aMember admin form saves the related_origins field.</p>
            <label>Related Origins JSON:</label>
            <textarea id="direct-config-value">["kumpe3d.com", "www.kumpe3d.com"]</textarea>
            <button onclick="testDirectConfigSave()">Simulate Direct Config Save</button>
            <div id="direct-save-result"></div>
        </div>
        
        <div class="test-section">
            <h3>3. Well-Known File Check</h3>
            <button onclick="checkWellKnownFile()">Check .well-known/webauthn File</button>
            <div id="wellknown-check-result"></div>
        </div>
        
        <div class="test-section">
            <h3>4. Manual Well-Known Update</h3>
            <button onclick="manualWellKnownUpdate()">Force Well-Known Update</button>
            <div id="manual-update-result"></div>
        </div>
        
        <div class="test-section">
            <h3>5. Configuration Key Detection Test</h3>
            <p>Test which configuration key is being used and detected.</p>
            <button onclick="testConfigKeys()">Test All Config Keys</button>
            <div id="config-keys-result"></div>
        </div>
        
        <div class="test-section">
            <h3>6. Full Admin Simulation</h3>
            <p>Complete simulation of admin form save process.</p>
            <button onclick="runFullAdminSimulation()">Run Full Admin Simulation</button>
            <div id="full-simulation-result"></div>
        </div>
    </div>

    <script>
        async function makeRequest(url, data = null, method = null) {
            try {
                const options = {
                    method: method || (data ? 'POST' : 'GET'),
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                let text = '';
                try {
                    text = await response.text();
                } catch (e) {
                    return { error: 'Failed to read response', status: response.status };
                }
                
                try {
                    return JSON.parse(text);
                } catch (e) {
                    return { raw: text, status: response.status, headers: response.headers };
                }
            } catch (error) {
                return { error: error.message };
            }
        }
        
        async function testConfigDetection() {
            const resultDiv = document.getElementById('config-detection-result');
            resultDiv.innerHTML = '<div class="result info">Testing configuration detection...</div>';
            
            const result = await makeRequest('/api/passkey/config');
            
            let html = `<div class="result ${result.error ? 'error' : 'success'}">
                <strong>Configuration Detection Result:</strong><br>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            </div>`;
            
            if (result.relatedOrigins) {
                html += `<div class="result info">
                    <strong>Related Origins Found:</strong><br>
                    RP ID: ${result.relatedOrigins.rpId}<br>
                    Origins: ${JSON.stringify(result.relatedOrigins.origins)}<br>
                    Well-Known URL: ${result.relatedOrigins.wellKnownUrl}
                </div>`;
            }
            
            resultDiv.innerHTML = html;
        }
        
        async function testDirectConfigSave() {
            const configValue = document.getElementById('direct-config-value').value.trim();
            const resultDiv = document.getElementById('direct-save-result');
            
            resultDiv.innerHTML = '<div class="result info">Testing direct config save...</div>';
            
            try {
                // Validate JSON first
                const parsedValue = JSON.parse(configValue);
                
                // Test adding each origin individually (this should trigger save hooks)
                const results = [];
                for (const origin of parsedValue) {
                    const result = await makeRequest('/api/passkey/config', {
                        action: 'add-origin',
                        origin: origin
                    });
                    results.push({ origin, result });
                }
                
                resultDiv.innerHTML = `<div class="result success">
                    <strong>Direct Config Save Results:</strong><br>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </div>`;
                
                // Auto-check config after save
                setTimeout(testConfigDetection, 1000);
                
            } catch (e) {
                resultDiv.innerHTML = `<div class="result error">Invalid JSON: ${e.message}</div>`;
            }
        }
        
        async function checkWellKnownFile() {
            const resultDiv = document.getElementById('wellknown-check-result');
            resultDiv.innerHTML = '<div class="result info">Checking .well-known file...</div>';
            
            const result = await makeRequest('/.well-known/webauthn');
            
            if (result.error) {
                resultDiv.innerHTML = `<div class="result error">
                    <strong>.well-known File Error:</strong><br>
                    ${result.error}
                </div>`;
                return;
            }
            
            let content;
            if (result.raw) {
                try {
                    content = JSON.parse(result.raw);
                } catch (e) {
                    content = result.raw;
                }
            } else {
                content = result;
            }
            
            resultDiv.innerHTML = `<div class="result success">
                <strong>.well-known File Content:</strong><br>
                <pre>${JSON.stringify(content, null, 2)}</pre>
            </div>`;
        }
        
        async function manualWellKnownUpdate() {
            const resultDiv = document.getElementById('manual-update-result');
            resultDiv.innerHTML = '<div class="result info">Forcing well-known file update...</div>';
            
            // Call config endpoint to trigger update
            const configResult = await makeRequest('/api/passkey/config');
            
            // Wait a moment then check the file
            setTimeout(async () => {
                const fileResult = await makeRequest('/.well-known/webauthn');
                
                resultDiv.innerHTML = `
                    <div class="result info">
                        <strong>Config API Result:</strong><br>
                        <pre>${JSON.stringify(configResult, null, 2)}</pre>
                    </div>
                    <div class="result ${fileResult.error ? 'error' : 'success'}">
                        <strong>.well-known File After Update:</strong><br>
                        <pre>${JSON.stringify(fileResult, null, 2)}</pre>
                    </div>
                `;
            }, 1000);
        }
        
        async function testConfigKeys() {
            const resultDiv = document.getElementById('config-keys-result');
            resultDiv.innerHTML = '<div class="result info">Testing configuration key detection...</div>';
            
            // This test would require PHP endpoint that shows which keys are found
            // For now, just show the config result
            const result = await makeRequest('/api/passkey/config');
            
            resultDiv.innerHTML = `
                <div class="result info">
                    <strong>Configuration Keys Test:</strong><br>
                    Based on the config result, we can see which key is being used.<br>
                    Look for debug information in the console or server logs.
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </div>
                <div class="result warning">
                    <strong>Note:</strong> Check browser console and server error logs for key detection messages.
                </div>
            `;
        }
        
        async function runFullAdminSimulation() {
            const resultDiv = document.getElementById('full-simulation-result');
            resultDiv.innerHTML = '<div class="result info">Running full admin simulation...</div>';
            
            const steps = [];
            const results = {};
            
            // Step 1: Check initial state
            steps.push('1. Checking initial configuration...');
            results.initial = await makeRequest('/api/passkey/config');
            steps.push(`   â†’ Initial config loaded: ${results.initial.ok ? 'SUCCESS' : 'FAILED'}`);
            
            // Step 2: Add origins (simulating admin form save)
            steps.push('2. Simulating admin form save with new origins...');
            const testOrigins = ['test1.example.com', 'test2.example.com'];
            results.adds = [];
            
            for (const origin of testOrigins) {
                const addResult = await makeRequest('/api/passkey/config', {
                    action: 'add-origin',
                    origin: origin
                });
                results.adds.push(addResult);
                steps.push(`   â†’ Added ${origin}: ${addResult.ok ? 'SUCCESS' : 'FAILED'}`);
            }
            
            // Step 3: Check configuration after changes
            steps.push('3. Checking configuration after admin save...');
            results.afterAdd = await makeRequest('/api/passkey/config');
            steps.push(`   â†’ Config after save: ${results.afterAdd.ok ? 'SUCCESS' : 'FAILED'}`);
            
            // Step 4: Check .well-known file
            steps.push('4. Checking .well-known file after admin save...');
            results.wellKnown = await makeRequest('/.well-known/webauthn');
            steps.push(`   â†’ Well-known file: ${results.wellKnown.error ? 'ERROR' : 'SUCCESS'}`);
            
            // Step 5: Clean up test origins
            steps.push('5. Cleaning up test origins...');
            results.removes = [];
            
            for (const origin of testOrigins) {
                const removeResult = await makeRequest('/api/passkey/config', {
                    action: 'remove-origin',
                    origin: origin
                });
                results.removes.push(removeResult);
                steps.push(`   â†’ Removed ${origin}: ${removeResult.ok ? 'SUCCESS' : 'FAILED'}`);
            }
            
            // Step 6: Final state check
            steps.push('6. Final configuration check...');
            results.final = await makeRequest('/api/passkey/config');
            steps.push(`   â†’ Final config: ${results.final.ok ? 'SUCCESS' : 'FAILED'}`);
            
            resultDiv.innerHTML = `
                <div class="result info">
                    <strong>Full Admin Simulation Results:</strong><br>
                    <pre>${steps.join('\n')}</pre>
                </div>
                <div class="result ${results.wellKnown.error ? 'error' : 'success'}">
                    <strong>Critical Test - Well-Known File After Admin Save:</strong><br>
                    <pre>${JSON.stringify(results.wellKnown, null, 2)}</pre>
                </div>
                <div class="result info">
                    <strong>Full Results Data:</strong><br>
                    <pre>${JSON.stringify(results, null, 2)}</pre>
                </div>
            `;
        }
        
        // Auto-load initial tests
        window.addEventListener('load', () => {
            testConfigDetection();
        });
    </script>
</body>
</html>
